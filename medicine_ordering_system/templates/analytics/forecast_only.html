{% extends 'base.html' %}
{% load static %}

{% block title %}Forecast Analytics - OnCare{% endblock %}

{% block extra_css %}
<style>
    .forecast-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #007bff;
    }
    
    .forecast-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .medicine-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
    }
    
    .model-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    
    .forecast-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .no-data-message {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .no-data-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 0;
        margin-bottom: 30px;
        border-radius: 0 0 20px 20px;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-top: 10px;
    }
    
    .medicine-selector {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .selector-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
    }
    
    .medicine-dropdown {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.3s ease;
    }
    
    .medicine-dropdown:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .forecast-card.hidden {
        display: none;
    }
    
    .show-all-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .show-all-btn:hover {
        background: #218838;
    }
    
    .show-all-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">
            <i class="fas fa-chart-line me-3"></i>Forecast Analytics
        </h1>
        <p class="page-subtitle">Best-performing demand forecasts for inventory planning</p>
    </div>
</div>

<div class="container">
    {% if forecasts %}
        <!-- Medicine Selector -->
        <div class="medicine-selector">
            <div class="selector-header">
                <h3 class="selector-title">
                    <i class="fas fa-filter me-2"></i>Select Medicine to View
                </h3>
                <button class="show-all-btn" id="showAllBtn" onclick="showAllForecasts()">
                    <i class="fas fa-eye me-1"></i>Show All
                </button>
            </div>
            <select class="medicine-dropdown" id="medicineSelect" onchange="filterForecasts()">
                <option value="">-- Select a medicine to view its forecast --</option>
                {% for medicine in medicines %}
                <option value="{{ medicine.id }}">{{ medicine.name }} ({{ medicine.strength }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-pills me-2"></i>Medicine Forecasts
                        <span class="badge bg-primary ms-2" id="visibleCount">{{ total_medicines }}</span>
                    </h2>
                    <div>
                        {% if user.is_admin %}
                        <a href="{% url 'analytics:dashboard' %}" class="btn btn-outline-light me-2">
                            <i class="fas fa-chart-bar me-1"></i>Full Analytics
                        </a>
                        {% endif %}
                        <a href="{% url 'analytics:model_evaluation' %}" class="btn btn-outline-light">
                            <i class="fas fa-cogs me-1"></i>Model Evaluation
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {% for forecast_item in forecasts %}
        <div class="forecast-card" data-medicine-id="{{ forecast_item.forecast.medicine.id }}" data-medicine-name="{{ forecast_item.forecast.medicine.name }}">
            <div class="forecast-header">
                <h3 class="medicine-title">
                    <i class="fas fa-pills me-2"></i>{{ forecast_item.forecast.medicine.name }}
                </h3>
                <div class="model-info">
                    <strong>{{ forecast_item.model_info.arima_params }}</strong>
                    <br>
                    <small>AIC: {{ forecast_item.model_info.aic|floatformat:2 }} | MAPE: {{ forecast_item.model_info.mape|floatformat:2 }}%</small>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="forecastChart{{ forloop.counter }}"></canvas>
            </div>
            
            <div class="forecast-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ forecast_item.forecast.forecast_period|title }}</div>
                    <div class="stat-label">Forecast Period</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ forecast_item.forecast.forecast_horizon }}</div>
                    <div class="stat-label">Forecast Horizon</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ forecast_item.forecast.created_at|date:"M d, Y" }}</div>
                    <div class="stat-label">Generated Date</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ forecast_item.forecast.training_data_points }}</div>
                    <div class="stat-label">Training Points</div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-data-message">
            <div class="no-data-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3>No Forecasts Available</h3>
            <p>{{ message|default:"Please generate some forecasts first to view forecast analytics." }}</p>
            {% if user.is_admin %}
            <a href="{% url 'analytics:dashboard' %}" class="btn btn-primary mt-3">
                <i class="fas fa-plus me-1"></i>Generate Forecasts
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let forecastCharts = {}; // Store chart instances

document.addEventListener('DOMContentLoaded', function() {
    {% for forecast_item in forecasts %}
    createForecastChart({{ forloop.counter }}, {{ forecast_item.chart_data|safe }});
    {% endfor %}
});

// Filter forecasts based on selected medicine
function filterForecasts() {
    const select = document.getElementById('medicineSelect');
    const selectedMedicineId = select.value;
    const forecastCards = document.querySelectorAll('.forecast-card');
    const visibleCount = document.getElementById('visibleCount');
    const showAllBtn = document.getElementById('showAllBtn');
    
    let visibleCountNum = 0;
    
    forecastCards.forEach(card => {
        const medicineId = card.getAttribute('data-medicine-id');
        
        if (selectedMedicineId === '' || selectedMedicineId === medicineId) {
            card.classList.remove('hidden');
            visibleCountNum++;
        } else {
            card.classList.add('hidden');
        }
    });
    
    // Update visible count
    visibleCount.textContent = visibleCountNum;
    
    // Update show all button state
    if (selectedMedicineId === '') {
        showAllBtn.disabled = true;
        showAllBtn.innerHTML = '<i class="fas fa-eye me-1"></i>All Shown';
    } else {
        showAllBtn.disabled = false;
        showAllBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Show All';
    }
    
    // Resize charts after filtering
    setTimeout(() => {
        resizeVisibleCharts();
    }, 100);
}

// Show all forecasts
function showAllForecasts() {
    const select = document.getElementById('medicineSelect');
    select.value = '';
    filterForecasts();
}

function createForecastChart(chartId, data) {
    const ctx = document.getElementById('forecastChart' + chartId).getContext('2d');
    
    // Prepare data arrays
    const historicalData = data.historical ? data.historical.values : [];
    const forecastData = data.forecast ? data.forecast.values : [];
    
    // Create combined data array with nulls for forecast periods in historical data
    const combinedHistoricalData = [...historicalData];
    const combinedForecastData = [...Array(historicalData.length).fill(null), ...forecastData];
    
    // Store chart instance for potential resizing
    forecastCharts[chartId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels || [],
            datasets: [{
                label: 'Historical Demand',
                data: combinedHistoricalData,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false
            }, {
                label: 'Forecasted Demand',
                data: combinedForecastData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderDash: [5, 5],
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Demand Forecast',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        title: function(tooltipItems) {
                            return data.labels[tooltipItems[0].dataIndex] || 'Unknown Period';
                        },
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(2) + ' units';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time Period'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantity (Units)'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

// Resize charts when they become visible
function resizeVisibleCharts() {
    Object.values(forecastCharts).forEach(chart => {
        if (chart && !chart.canvas.closest('.forecast-card').classList.contains('hidden')) {
            chart.resize();
        }
    });
}

// Add resize observer for better chart handling
if (window.ResizeObserver) {
    const resizeObserver = new ResizeObserver(entries => {
        resizeVisibleCharts();
    });
    
    document.querySelectorAll('.forecast-card').forEach(card => {
        resizeObserver.observe(card);
    });
}
</script>
{% endblock %}
