{% extends 'base.html' %}
{% load static %}

{% block title %}ARIMA Step-by-Step Demonstration - Analytics{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-x: hidden;
        overflow-y: auto;
    }
    
    .container-fluid {
        padding-bottom: 50px;
        min-height: 100vh;
    }
    
    .step-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow: visible;
        position: relative;
        z-index: 1;
        border: 1px solid #e9ecef;
    }
    
    .step-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        text-align: center;
    }
    
    .step-title {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .step-description {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .step-content {
        padding: 30px;
        min-height: 400px;
    }
    
    .analysis-text {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 20px;
        margin: 20px 0;
        border-radius: 0 8px 8px 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .step-navigation {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .step-btn {
        padding: 12px 24px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 25px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s ease;
        min-width: 60px;
        text-align: center;
    }
    
    .step-btn:hover {
        background: #667eea;
        color: white;
        text-decoration: none;
    }
    
    .step-btn.active {
        background: #667eea;
        color: white;
    }
    
    .controls-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        text-align: center;
        width: 100%;
        position: relative;
        z-index: 1;
        border: 1px solid #e9ecef;
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        text-align: center;
    }
    
    .chart-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: block;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 60px;
    }
    
    .spinner-border {
        width: 4rem;
        height: 4rem;
        color: #667eea;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        display: inline-block;
        margin: 5px;
    }
    
    .status-stationary {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-non-stationary {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-strong {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .status-weak {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-excellent {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-good {
        background-color: #cce5ff;
        color: #004085;
    }
    
    .status-fair {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-poor {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .forecast-values {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .forecast-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .forecast-item:last-child {
        border-bottom: none;
    }
    
    .forecast-month {
        font-weight: bold;
        color: #495057;
    }
    
    .forecast-value {
        color: #667eea;
        font-family: monospace;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .step-navigation {
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .step-btn {
            min-width: 50px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .chart-container {
            padding: 15px;
        }
        
        .step-content {
            padding: 20px;
        }
        
        .metrics-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Ensure page is scrollable */
    html, body {
        height: auto;
        overflow-x: hidden;
        position: relative;
    }
    
    /* Ensure footer stays at bottom */
    footer {
        position: relative;
        clear: both;
        margin-top: 50px;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    /* Ensure no overlapping */
    .step-container {
        margin-bottom: 40px;
    }
    
    .chart-container {
        margin-bottom: 40px;
    }
    
    .main-content {
        min-height: calc(100vh - 200px);
        padding-bottom: 50px;
    }
    
    /* Ensure visualizations are properly integrated */
    .step-content {
        position: relative;
        overflow: visible;
    }
    
    .chart-container {
        position: relative;
        overflow: visible;
        margin-bottom: 30px;
    }
    
    .chart-container img {
        max-width: 100% !important;
        height: auto !important;
        display: block !important;
        margin: 0 auto !important;
        position: relative !important;
        vertical-align: top;
    }
    
    /* Fix any floating elements */
    * {
        box-sizing: border-box;
    }
    
    .row {
        margin-left: 0;
        margin-right: 0;
        position: relative;
    }
    
    .col-12 {
        padding-left: 0;
        padding-right: 0;
        position: relative;
    }
    
    /* Ensure proper page flow */
    .container-fluid {
        position: relative;
        overflow: visible;
    }
    
    .main-content {
        position: relative;
        overflow: visible;
    }
    
    /* Clearfix utility */
    .clearfix::after {
        content: "";
        display: table;
        clear: both;
    }
    
    /* Ensure proper page structure */
    .page-wrapper {
        position: relative;
        min-height: 100vh;
        display: block;
    }
    
    .content-wrapper {
        position: relative;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="content-wrapper">
        <div class="container-fluid main-content">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="fas fa-microscope"></i> ARIMA Step-by-Step Demonstration
                </h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="runStepAnalysis()">
                        <i class="fas fa-play"></i> Run Analysis
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-card">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="medicineSelect">Select Medicine:</label>
                    <select class="form-control" id="medicineSelect">
                        {% for medicine in medicines %}
                        <option value="{{ medicine.id }}" {% if medicine.id == selected_medicine.id %}selected{% endif %}>
                            {{ medicine.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="stepSelect">Current Step:</label>
                    <select class="form-control" id="stepSelect">
                        <option value="1" {% if current_step == '1' %}selected{% endif %}>Step 1: Stationarity Testing</option>
                        <option value="2" {% if current_step == '2' %}selected{% endif %}>Step 2: Seasonal Decomposition</option>
                        <option value="3" {% if current_step == '3' %}selected{% endif %}>Step 3: Model Selection</option>
                        <option value="4" {% if current_step == '4' %}selected{% endif %}>Step 4: Model Evaluation</option>
                        <option value="5" {% if current_step == '5' %}selected{% endif %}>Step 5: Forecast Generation</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> This demonstration uses monthly data for optimal ARIMA analysis. The step-by-step process shows how ARIMA models work with time series data.
                </div>
            </div>
        </div>
    </div>

    <!-- Step Navigation -->
    <div class="step-navigation">
        <a href="?step=1&medicine_id={{ selected_medicine.id }}" 
           class="step-btn {% if current_step == '1' %}active{% endif %}">Step 1</a>
        <a href="?step=2&medicine_id={{ selected_medicine.id }}" 
           class="step-btn {% if current_step == '2' %}active{% endif %}">Step 2</a>
        <a href="?step=3&medicine_id={{ selected_medicine.id }}" 
           class="step-btn {% if current_step == '3' %}active{% endif %}">Step 3</a>
        <a href="?step=4&medicine_id={{ selected_medicine.id }}" 
           class="step-btn {% if current_step == '4' %}active{% endif %}">Step 4</a>
        <a href="?step=5&medicine_id={{ selected_medicine.id }}" 
           class="step-btn {% if current_step == '5' %}active{% endif %}">Step 5</a>
    </div>

    <!-- Loading Section -->
    <div id="loadingSection" class="loading-spinner" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-3">Running ARIMA step analysis...</p>
    </div>

    <!-- Analysis Results -->
    <div id="analysisResults" style="display: none;">
        <div class="step-container">
            <div class="step-header">
                <div class="step-title" id="stepTitle">-</div>
                <div class="step-description" id="stepDescription">-</div>
            </div>
            <div class="step-content">
                <!-- Data Information -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5>Data Information</h5>
                        <div class="metrics-grid" id="dataMetrics">
                            <!-- Data metrics will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Step-specific Analysis -->
                <div id="stepAnalysis">
                    <!-- Step-specific content will be populated here -->
                </div>

                <!-- Visualization -->
                <div class="chart-container">
                    <div class="chart-title">Visualization</div>
                    <div id="chartLoading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading chart...</span>
                        </div>
                        <p class="mt-2">Generating visualization...</p>
                    </div>
                    <img id="stepChart" src="" alt="Step Chart" class="chart-image" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer spacer to ensure content is fully visible -->
    <div style="height: 50px;"></div>
    
        </div>
    </div>
    
    <!-- Scroll to top button -->
    <button id="scrollToTop" class="btn btn-primary" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: none; border-radius: 50%; width: 50px; height: 50px;">
        <i class="fas fa-arrow-up"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStepData = null;

// Run step analysis
async function runStepAnalysis() {
    const medicineId = document.getElementById('medicineSelect').value;
    const step = document.getElementById('stepSelect').value;
    const periodType = 'monthly'; // Fixed to monthly for ARIMA demonstration
    
    // Show loading
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('analysisResults').style.display = 'none';
    
    try {
        const response = await fetch(`/analytics/api/arima-step-analysis/?medicine_id=${medicineId}&period_type=${periodType}&step=${step}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentStepData = data;
        displayStepResults(data);
        
        // Hide loading and show results
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('analysisResults').style.display = 'block';
        
    } catch (error) {
        console.error('Step analysis failed:', error);
        alert('Step analysis failed: ' + error.message);
        document.getElementById('loadingSection').style.display = 'none';
    }
}

// Display step results
function displayStepResults(data) {
    const analysis = data.analysis;
    
    // Update step title and description
    document.getElementById('stepTitle').textContent = analysis.title || 'Step Analysis';
    document.getElementById('stepDescription').textContent = analysis.description || 'Analysis in progress...';
    
    // Display data metrics
    displayDataMetrics(data.data_info);
    
    // Display step-specific analysis
    displayStepAnalysis(analysis);
    
    // Display chart
    if (analysis.chart) {
        const chartImg = document.getElementById('stepChart');
        const chartLoading = document.getElementById('chartLoading');
        
        // Show loading state
        chartLoading.style.display = 'block';
        chartImg.style.display = 'none';
        
        // Set up chart image
        chartImg.src = analysis.chart;
        chartImg.style.maxWidth = '100%';
        chartImg.style.height = 'auto';
        chartImg.style.margin = '0 auto';
        chartImg.style.position = 'relative';
        chartImg.style.zIndex = '1';
        
        // Handle chart loading
        chartImg.onload = function() {
            chartLoading.style.display = 'none';
            chartImg.style.display = 'block';
            chartImg.style.opacity = '1';
        };
        chartImg.onerror = function() {
            chartLoading.style.display = 'none';
            console.error('Chart failed to load');
        };
    } else {
        // Hide loading if no chart
        document.getElementById('chartLoading').style.display = 'none';
    }
}

// Display data metrics
function displayDataMetrics(dataInfo) {
    const metricsContainer = document.getElementById('dataMetrics');
    metricsContainer.innerHTML = `
        <div class="metric-card">
            <div class="metric-value">${dataInfo.total_points}</div>
            <div class="metric-label">Data Points</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">${dataInfo.statistics.mean.toFixed(2)}</div>
            <div class="metric-label">Mean Quantity</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">${dataInfo.statistics.std.toFixed(2)}</div>
            <div class="metric-label">Std Deviation</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">${dataInfo.statistics.min.toFixed(0)} - ${dataInfo.statistics.max.toFixed(0)}</div>
            <div class="metric-label">Range</div>
        </div>
    `;
}

// Display step-specific analysis
function displayStepAnalysis(analysis) {
    const container = document.getElementById('stepAnalysis');
    let html = '';
    
    if (analysis.error) {
        html = `<div class="alert alert-danger">${analysis.error}</div>`;
    } else {
        // Step 1: Stationarity
        if (analysis.step === '1') {
            html = `
                <div class="analysis-text">
                    <h6>Augmented Dickey-Fuller Test Results:</h6>
                    <p><strong>ADF Statistic:</strong> ${analysis.adf_statistic.toFixed(6)}</p>
                    <p><strong>p-value:</strong> ${analysis.p_value.toFixed(6)}</p>
                    <p><strong>Critical Values:</strong></p>
                    <ul>
                        <li>1%: ${analysis.critical_values['1%'].toFixed(6)}</li>
                        <li>5%: ${analysis.critical_values['5%'].toFixed(6)}</li>
                        <li>10%: ${analysis.critical_values['10%'].toFixed(6)}</li>
                    </ul>
                    <p><strong>Conclusion:</strong> 
                        <span class="status-badge ${analysis.is_stationary ? 'status-stationary' : 'status-non-stationary'}">
                            ${analysis.conclusion}
                        </span>
                    </p>
                </div>
            `;
        }
        // Step 2: Seasonal Decomposition
        else if (analysis.step === '2') {
            html = `
                <div class="analysis-text">
                    <h6>Seasonal Decomposition Results:</h6>
                    <p><strong>Trend Present:</strong> ${analysis.trend_present ? 'Yes' : 'No'}</p>
                    <p><strong>Seasonal Present:</strong> ${analysis.seasonal_present ? 'Yes' : 'No'}</p>
                    <p><strong>Residual Present:</strong> ${analysis.residual_present ? 'Yes' : 'No'}</p>
                    <p><strong>Seasonal Strength:</strong> ${(analysis.seasonal_strength * 100).toFixed(2)}%</p>
                    <p><strong>Seasonal Pattern:</strong> 
                        <span class="status-badge ${analysis.strong_seasonal ? 'status-strong' : 'status-weak'}">
                            ${analysis.strong_seasonal ? 'STRONG' : 'WEAK'}
                        </span>
                    </p>
                </div>
            `;
        }
        // Step 3: Model Selection
        else if (analysis.step === '3') {
            html = `
                <div class="analysis-text">
                    <h6>Selected ARIMA Model:</h6>
                    <p><strong>Non-seasonal ARIMA:</strong> ARIMA(${analysis.order[0]},${analysis.order[1]},${analysis.order[2]})</p>
                    <p><strong>Seasonal ARIMA:</strong> SARIMA(${analysis.seasonal_order[0]},${analysis.seasonal_order[1]},${analysis.seasonal_order[2]})[${analysis.seasonal_order[3]}]</p>
                    <p><strong>Total Parameters:</strong> ${analysis.total_params}</p>
                    <p><strong>AIC:</strong> ${analysis.aic.toFixed(3)}</p>
                    <p><strong>BIC:</strong> ${analysis.bic.toFixed(3)}</p>
                </div>
            `;
        }
        // Step 4: Model Evaluation
        else if (analysis.step === '4') {
            html = `
                <div class="analysis-text">
                    <h6>Model Evaluation Results:</h6>
                    <p><strong>RMSE:</strong> ${analysis.rmse.toFixed(3)}</p>
                    <p><strong>MAE:</strong> ${analysis.mae.toFixed(3)}</p>
                    <p><strong>MAPE:</strong> ${analysis.mape.toFixed(2)}%</p>
                    <p><strong>AIC:</strong> ${analysis.aic.toFixed(3)}</p>
                    <p><strong>BIC:</strong> ${analysis.bic.toFixed(3)}</p>
                    <p><strong>Performance:</strong> 
                        <span class="status-badge status-${analysis.performance.toLowerCase()}">
                            ${analysis.performance}
                        </span>
                    </p>
                </div>
            `;
        }
        // Step 5: Forecast Generation
        else if (analysis.step === '5') {
            html = `
                <div class="analysis-text">
                    <h6>Forecast Statistics:</h6>
                    <p><strong>Mean Forecast:</strong> ${analysis.forecast_mean.toFixed(2)}</p>
                    <p><strong>Standard Deviation:</strong> ${analysis.forecast_std.toFixed(2)}</p>
                    <p><strong>Minimum Forecast:</strong> ${analysis.forecast_min.toFixed(2)}</p>
                    <p><strong>Maximum Forecast:</strong> ${analysis.forecast_max.toFixed(2)}</p>
                </div>
                <div class="forecast-values">
                    <h6>12-Month Forecast Values:</h6>
                    ${analysis.forecast_values.map((value, index) => `
                        <div class="forecast-item">
                            <span class="forecast-month">Month ${index + 1}:</span>
                            <span class="forecast-value">${value.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    }
    
    container.innerHTML = html;
}

// Refresh data
function refreshData() {
    if (currentStepData) {
        runStepAnalysis();
    }
}

// Event listeners
document.getElementById('medicineSelect').addEventListener('change', function() {
    updateURL();
});
document.getElementById('stepSelect').addEventListener('change', function() {
    updateURL();
});

// Update URL when parameters change
function updateURL() {
    const medicineId = document.getElementById('medicineSelect').value;
    const step = document.getElementById('stepSelect').value;
    const newURL = `?step=${step}&medicine_id=${medicineId}`;
    window.history.pushState({}, '', newURL);
}

// Scroll to top functionality
window.addEventListener('scroll', function() {
    const scrollToTopBtn = document.getElementById('scrollToTop');
    if (window.pageYOffset > 300) {
        scrollToTopBtn.style.display = 'block';
    } else {
        scrollToTopBtn.style.display = 'none';
    }
});

document.getElementById('scrollToTop').addEventListener('click', function() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Auto-run analysis on page load
    runStepAnalysis();
    
    // Ensure page is fully loaded and scrollable
    setTimeout(function() {
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';
    }, 100);
});
</script>
{% endblock %}
